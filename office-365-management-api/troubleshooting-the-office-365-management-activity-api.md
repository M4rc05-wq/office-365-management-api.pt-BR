---
ms.technology: o365-service-communications
ms.TocTitle: Troubleshooting the Office 365 Management Activity API
title: Solução de problemas da API da Atividade de Gerenciamento do Office 365
description: Resume as perguntas mais comuns que o Suporte da Microsoft recebe no suporte a essa API.
ms.ContentId: 50822603-a1ec-a754-e7dc-67afe36bb1b0
ms.topic: reference (API)
ms.date: ''
localization_priority: Priority
ms.openlocfilehash: a65c8dff39d80b57b1c885639be2e228e8119cb7
ms.sourcegitcommit: 263cfbc04033ea8a1d765215e8777739587818e0
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/13/2020
ms.locfileid: "49021006"
---
# <a name="office-365-management-activity-api-faqs-and-troubleshooting"></a><span data-ttu-id="4e894-103">Perguntas frequentes e Soluções de problemas da API da Atividade de Gestão do Office 365</span><span class="sxs-lookup"><span data-stu-id="4e894-103">Office 365 Management Activity API FAQs and troubleshooting</span></span>

<span data-ttu-id="4e894-104">A API da Atividade de Gestão do Office 365 (também conhecida como a *API de Auditoria Unificada*) é apenas uma parte das ofertas de conformidade e segurança do Office 365, que:</span><span class="sxs-lookup"><span data-stu-id="4e894-104">The Office 365 Management Activity API (also known as the *Unified Auditing API*) is a part of Office 365 security and compliance offerings, that:</span></span>

- <span data-ttu-id="4e894-105">Permite o acesso programático a várias cargas de trabalho de pipeline de auditoria (como o SharePoint e o Exchange)</span><span class="sxs-lookup"><span data-stu-id="4e894-105">Allows programmatic access to multiple auditing pipeline workloads (such as SharePoint and Exchange)</span></span>

- <span data-ttu-id="4e894-106">É a principal interface usada por uma variedade de produtos de fornecedores de terceiros para agregar e indexar dados de auditoria</span><span class="sxs-lookup"><span data-stu-id="4e894-106">Is the main interface used by a variety of third-party vendor products to aggregate and index auditing data</span></span>

<span data-ttu-id="4e894-107">A API da Atividade de Gestão não deve ser confundida com a API de Comunicações de Serviço do Office 365.</span><span class="sxs-lookup"><span data-stu-id="4e894-107">The Management Activity API shouldn't be confused with the Office 365 Service Communications API.</span></span> <span data-ttu-id="4e894-108">A API da Atividade de Gerenciamento serve para auditar as atividades do usuário final em várias cargas de trabalho.</span><span class="sxs-lookup"><span data-stu-id="4e894-108">The Management Activity API is for auditing end user activities in the various workloads.</span></span> <span data-ttu-id="4e894-109">A API do Serviço de Comunicações serve para auditar o status e as mensagens enviadas pelos serviços disponíveis no Office 365 (como Dynamics CRM ou Serviço de Identidade).</span><span class="sxs-lookup"><span data-stu-id="4e894-109">The Service Communications API is for auditing status and messages that are sent by the services that are available in Office 365 (such as Dynamics CRM or Identity Service).</span></span>
 
> [!NOTE]
> <span data-ttu-id="4e894-110">Houve um problema com eventos pertencentes ao tipo de conteúdo Audit.AzureActiveDirectory não disponíveis por meio da API da Atividade de Gestão do Office 365 entre 22 de outubro de 2020 e 6 de novembro de 2020.</span><span class="sxs-lookup"><span data-stu-id="4e894-110">There was an issue with events belonging to the Audit.AzureActiveDirectory content type not being available via the Office 365 Management Activity API between October 22, 2020 and November 6, 2020.</span></span> <span data-ttu-id="4e894-111">Os eventos de entrada do Microsoft Azure Active Directory não foram afetados por esse problema.</span><span class="sxs-lookup"><span data-stu-id="4e894-111">Azure AD signin events were not affected by this issue.</span></span> <span data-ttu-id="4e894-112">Os eventos ausentes para o período de impacto estarão disponíveis nos próximos dias, e espera-se que sejam concluídos o mais tardar até 20 de novembro de 2020.</span><span class="sxs-lookup"><span data-stu-id="4e894-112">The missing events for the period of impact will be available over the next few days, and is expected to take no later than November 20, 2020 to complete.</span></span> <span data-ttu-id="4e894-113">Em alguns casos, os clientes podem notar dados de eventos duplicados para eventos gerados entre 26 de outubro de 2020 e 5 de novembro de 2020.</span><span class="sxs-lookup"><span data-stu-id="4e894-113">In some cases, customers might notice duplicate event data for events generated between October 26, 2020 and November 5, 2020.</span></span>

## <a name="frequently-asked-questions-about-the-office-365-management-activity-api"></a><span data-ttu-id="4e894-114">Perguntas frequentes sobre a API da Atividade de Gestão do Office 365</span><span class="sxs-lookup"><span data-stu-id="4e894-114">Frequently asked questions about the Office 365 Management Activity API</span></span>

<span data-ttu-id="4e894-115">**Como faço para integrar a API de Atividade de Gerenciamento?**</span><span class="sxs-lookup"><span data-stu-id="4e894-115">**How do I onboard to the Management Activity API?**</span></span>

<span data-ttu-id="4e894-116">Para começar a usar a API da Atividade de Gestão do Office 365, confira [ Introdução às APIs de Gerenciamento do Office 365 ](get-started-with-office-365-management-apis.md).</span><span class="sxs-lookup"><span data-stu-id="4e894-116">To get started with the Office 365 Management Activity API, see [Get started with Office 365 Management APIs](get-started-with-office-365-management-apis.md).</span></span>

<span data-ttu-id="4e894-117">**O que acontece se eu desabilitar a auditoria para a minha organização do Office 365? Ainda terei os eventos pela API da Atividade de Gestão?**</span><span class="sxs-lookup"><span data-stu-id="4e894-117">**What happens if I disable auditing for my Office 365 organization? Will I still get events via the Management Activity API?**</span></span>

<span data-ttu-id="4e894-118">Não.</span><span class="sxs-lookup"><span data-stu-id="4e894-118">No.</span></span> <span data-ttu-id="4e894-119">A auditoria unificada do Office 365 deve estar habilitada na sua organização para incluir os registros por meio da API de Atividade de Gestão.</span><span class="sxs-lookup"><span data-stu-id="4e894-119">Office 365 unified auditing must be enabled for your organization to pull records via the Management Activity API.</span></span> <span data-ttu-id="4e894-120">Para obter instruções, confira [Ativar ou desativar a pesquisa de log de auditoria](https://docs.microsoft.com/microsoft-365/compliance/turn-audit-log-search-on-or-off).</span><span class="sxs-lookup"><span data-stu-id="4e894-120">For instructions, see [Turn audit log search on or off](https://docs.microsoft.com/microsoft-365/compliance/turn-audit-log-search-on-or-off).</span></span>

<span data-ttu-id="4e894-121">**Que eventos são auditados para um serviço específico do Office 365?**</span><span class="sxs-lookup"><span data-stu-id="4e894-121">**What events are audited for a specific Office 365 service?**</span></span>

<span data-ttu-id="4e894-122">A documentação do esquema de API da Atividade de Gestão do Office 365 possui uma lista abrangente de eventos.</span><span class="sxs-lookup"><span data-stu-id="4e894-122">Office 365 Management Activity API schema documentation has a comprehensive list of events.</span></span> <span data-ttu-id="4e894-123">Para ver mais detalhes, confira o esquema de API da Atividade de Gestão do Office 365.</span><span class="sxs-lookup"><span data-stu-id="4e894-123">For details, see Office 365 Management Activity API schema.</span></span> <span data-ttu-id="4e894-124">Confira também a seção "atividades auditadas" em [Pesquisar o log de auditoria no Centro de Conformidade e Segurança](https://docs.microsoft.com/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance#audited-activities) para obter uma lista de eventos para a maioria dos serviços do Office 365 que são auditados.</span><span class="sxs-lookup"><span data-stu-id="4e894-124">Also see the "Audited activities" section in [Search the audit log in the Security & Compliance Center](https://docs.microsoft.com/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance#audited-activities) for a list of events for most of the Office 365 services that are audited.</span></span>

<span data-ttu-id="4e894-125">**Há alguma diferença entre os registros buscados pela API da Atividade de Gestão e os registros retornados usando a ferramenta de pesquisa de log de auditoria no Centro de Conformidade do Microsoft 365?**</span><span class="sxs-lookup"><span data-stu-id="4e894-125">**Are there any differences in the records that are fetched by the Management Activity API versus the records that are returned by using the audit log search tool in the Microsoft 365 compliance center?**</span></span>

<span data-ttu-id="4e894-126">Os dados retornados pelos dois métodos são os mesmos.</span><span class="sxs-lookup"><span data-stu-id="4e894-126">The data that is returned by both methods is the same.</span></span> <span data-ttu-id="4e894-127">A única diferença é que, com a API, você pode obter dados apenas dos últimos sete dias (mais detalhes nas perguntas a seguir).</span><span class="sxs-lookup"><span data-stu-id="4e894-127">The only difference is that with the API, you can get data for the last 7 days only (more details in the questions below).</span></span> <span data-ttu-id="4e894-128">Ao pesquisar o log de auditoria no Centro de Conformidade e Segurança (ou usando o cmdlet **Search-UnifiedAuditLog** correspondente no Exchange Online PowerShell), é possível obter dados do período de retenção ativos quando o dado foi gerado (por exemplo, 90 dias ou uma ano).</span><span class="sxs-lookup"><span data-stu-id="4e894-128">When searching the audit log in the Security & Compliance Center (or by using the corresponding **Search-UnifiedAuditLog** cmdlet in Exchange Online PowerShell), you can get data for the retention period in effect when the data is generated (for example, 90 days or one year).</span></span>

<span data-ttu-id="4e894-129">**Qual é o tempo máximo que terei que esperar antes de uma notificação ser enviada sobre um determinado evento do Office 365?**</span><span class="sxs-lookup"><span data-stu-id="4e894-129">**What is the maximum time I will have to wait before a notification is sent about a given Office 365 event?**</span></span>

<span data-ttu-id="4e894-130">Não há nenhuma latência máxima garantida para a entrega de notificação (ou seja, nenhum SLA).</span><span class="sxs-lookup"><span data-stu-id="4e894-130">There is no guaranteed maximum latency for notification delivery (in other words, there is no SLA).</span></span> <span data-ttu-id="4e894-131">Geralmente, a maioria das notificações é enviada dentro de uma hora do evento.</span><span class="sxs-lookup"><span data-stu-id="4e894-131">Typically, most notifications are sent within one hour of the event.</span></span> <span data-ttu-id="4e894-132">Geralmente, a latência é muito mais curta, mas esse período pode ser mais demorado, de acordo com a carga de trabalho.</span><span class="sxs-lookup"><span data-stu-id="4e894-132">Often the latency is much shorter, but this period might be longer since this varies from workload to workload.</span></span>

<span data-ttu-id="4e894-133">**As notificações webhook não são mais imediatas?**</span><span class="sxs-lookup"><span data-stu-id="4e894-133">**Aren't webhook notifications more immediate?**</span></span>

<span data-ttu-id="4e894-134">Não.</span><span class="sxs-lookup"><span data-stu-id="4e894-134">No.</span></span> <span data-ttu-id="4e894-135">Recentemente, o tempo de espera de entrega de notificações ao usar um webhook tem sido maior se comparado à consulta da API diretamente com a operação `/content`.</span><span class="sxs-lookup"><span data-stu-id="4e894-135">Recently, there have been longer wait times for notifications when using a webhook compared to querying the API directly with the `/content` operation.</span></span>

<span data-ttu-id="4e894-136">**Quanto tempo o conteúdo permanecerá disponível para buscar pela API?**</span><span class="sxs-lookup"><span data-stu-id="4e894-136">**How long will the content remain available to fetch via the API?**</span></span>

<span data-ttu-id="4e894-137">O conteúdo está disponível para ser obtido pela API por 7 dias após a notificação da disponibilidade do conteúdo.</span><span class="sxs-lookup"><span data-stu-id="4e894-137">Content is available to fetch via the API for 7 days after the notification of the content availability.</span></span> <span data-ttu-id="4e894-138">Mesmo que a notificação atrase por um período excepcionalmente longo (por exemplo, no caso de uma interrupção do serviço), você ainda terá sete dias após a primeira disponibilidade da notificação para baixar o blob de conteúdo relacionado ao evento de origem.</span><span class="sxs-lookup"><span data-stu-id="4e894-138">Even if the notification is delayed for an unusually long period (for example, in the case of a service interruption), you would still have 7 days after the first availability of the notification to download the content blob related to the originating event.</span></span>

<span data-ttu-id="4e894-139">**Posso consultar a API da Atividade de Gestão para uma ID de evento específico ou RecordType ou outras propriedades no blob de conteúdo?**</span><span class="sxs-lookup"><span data-stu-id="4e894-139">**Can I query the Management Activity API for a particular event ID or RecordType or other properties in the content blob?**</span></span>

<span data-ttu-id="4e894-140">Não.</span><span class="sxs-lookup"><span data-stu-id="4e894-140">No.</span></span> <span data-ttu-id="4e894-141">A API de Gerenciamento de Atividade fornece todos os detalhes do evento para um log específico.</span><span class="sxs-lookup"><span data-stu-id="4e894-141">The Management Activity API provides all the event details for a particular log.</span></span> <span data-ttu-id="4e894-142">Pode ser usado para baixar todos os detalhes e, em seguida, você pode implementar sua própria lógica de consulta nos dados baixados; por exemplo, usando um aplicativo personalizado do ou uma ferramenta de terceiros.</span><span class="sxs-lookup"><span data-stu-id="4e894-142">It can be used to download the entire details, and then you can implement your own query logic on the downloaded data; for example, by using a custom application or a third-party tool.</span></span>

<span data-ttu-id="4e894-143">**Como posso saber se estão precisos e completos os dados provenientes da minha solução de auditoria existente que coleta dados da API da Atividade de Gerenciamento?**</span><span class="sxs-lookup"><span data-stu-id="4e894-143">**How do I know the data coming from my existing auditing solution, which collects data from the Management Activity API, is accurate and complete?**</span></span>

<span data-ttu-id="4e894-144">A resposta curta é que a Microsoft não fornece nenhum tipo de log que permitirá verificar aplicativos ou aplicativos de terceiros (ISV).</span><span class="sxs-lookup"><span data-stu-id="4e894-144">The short answer is that Microsoft doesn't provide any kind of a log that allows you to cross-check any given application or third-party (ISV) application.</span></span> <span data-ttu-id="4e894-145">Há outros produtos de segurança da Microsoft que usam os dados da mesmo pipeline, mas esses produtos estão fora do escopo dessa discussão e não podem ser usados diretamente para verificar a API da Atividade de Gestão.</span><span class="sxs-lookup"><span data-stu-id="4e894-145">There are other Microsoft security products that obtain their data from the same pipeline, but those products fall outside the scope of this discussion and can't be used to directly cross-check the Management Activity API.</span></span> <span data-ttu-id="4e894-146">Se você estiver preocupado com discrepâncias entre o que sua solução existente fornece e o que espera, implemente as operações ilustradas acima.</span><span class="sxs-lookup"><span data-stu-id="4e894-146">If you're concerned about discrepancies between what your existing solution is providing and what you expect, you should implement the operations illustrated above.</span></span> <span data-ttu-id="4e894-147">Mas isso pode ser difícil, dependendo de como sua ferramenta ou solução existente lista e indexa os dados.</span><span class="sxs-lookup"><span data-stu-id="4e894-147">But this can be difficult, depending on how your existing tool or solution lists and indexes data.</span></span> <span data-ttu-id="4e894-148">Se sua solução existente apenas apresentar dados classificados por hora de criação do evento real, não será possível consultar a API por hora de criação do evento, para que você possa comparar conjuntos de resultados.</span><span class="sxs-lookup"><span data-stu-id="4e894-148">If your existing solution only presents data sorted by the creation time of the actual event, there's no way to query the API by event creation time so that you can compare result sets.</span></span> <span data-ttu-id="4e894-149">Nesse cenário, você precisará coletar os blobs de conteúdo notificados por vários dias, indexá-los ou classificá-los manualmente e fazer uma comparação simples.</span><span class="sxs-lookup"><span data-stu-id="4e894-149">In this scenario, you'd have to collect the notified content blobs for several days, index or sort them manually, and then do a manual comparison.</span></span>

<span data-ttu-id="4e894-150">**O que é a restrição de limitação para a API da Atividade de Gestão?**</span><span class="sxs-lookup"><span data-stu-id="4e894-150">**What is the throttling limit for the Management Activity API?**</span></span>

<span data-ttu-id="4e894-151">Todas as organizações alocam inicialmente uma linha de base de 2.000 solicitações por minuto.</span><span class="sxs-lookup"><span data-stu-id="4e894-151">All organizations are initially allocated a baseline of 2,000 requests per minute.</span></span> <span data-ttu-id="4e894-152">Em seguida, o limite é ajustado com base em uma combinação de fatores, incluindo o número de assentos na organização.</span><span class="sxs-lookup"><span data-stu-id="4e894-152">The throttling limit is then adjusted based on a combination of factors, including the number of seats in the organization.</span></span> <span data-ttu-id="4e894-153">Além disso, as organizações do Office 365 E5 e do Microsoft 365 E5 terão aproximadamente duas vezes mais largura de banda quanto organizações não-e5.</span><span class="sxs-lookup"><span data-stu-id="4e894-153">Also, Office 365 E5 and Microsoft 365 E5 organizations will get approximately twice as much bandwidth as non-E5 organizations.</span></span> <span data-ttu-id="4e894-154">Também haverá limite máximo quanto à largura de banda para proteger a integridade do serviço.</span><span class="sxs-lookup"><span data-stu-id="4e894-154">There will also be cap on the maximum bandwidth to protect the health of the service.</span></span>

> [!NOTE]
> <span data-ttu-id="4e894-155">Embora cada locatário possa enviar inicialmente até 2 mil solicitações por minuto, a Microsoft não pode garantir uma taxa de resposta.</span><span class="sxs-lookup"><span data-stu-id="4e894-155">Even though each tenant can initially submit up to 2,000 requests per minute, Microsoft cannot guarantee a response rate.</span></span> <span data-ttu-id="4e894-156">A taxa de resposta depende de vários fatores, como o desempenho do sistema do cliente, a capacidade e a velocidade da rede.</span><span class="sxs-lookup"><span data-stu-id="4e894-156">The response rate depends on various factors, such as client system performance, network capacity, and network speed.</span></span>

<span data-ttu-id="4e894-157">**Estou encontrando um erro de limitação na API da Atividade de Gestão. O que devo fazer?**</span><span class="sxs-lookup"><span data-stu-id="4e894-157">**I'm encountering a throttling error in the Management Activity API. What should I do?**</span></span>

<span data-ttu-id="4e894-158">Abra um tíquete com o Suporte da Microsoft e solicite uma nova restrição de limitação, além de incluir uma justificativa comercial para aumentar o limite.</span><span class="sxs-lookup"><span data-stu-id="4e894-158">Open a ticket with Microsoft Support and request a new throttling limit, and include a business justification for increasing the limit.</span></span> <span data-ttu-id="4e894-159">Nós avaliaremos a solicitação e, se aceita, aumentaremos a restrição de limitação.</span><span class="sxs-lookup"><span data-stu-id="4e894-159">We will evaluate the request, and if accepted, we will increase the throttling limit.</span></span>

<span data-ttu-id="4e894-160">**Por que as TargetUpdatedProperties não estão mais em ExtendedProperties nos logs de auditoria das atividades do Azure Active Directory?**</span><span class="sxs-lookup"><span data-stu-id="4e894-160">**Why are TargetUpdatedProperties no longer in ExtendedProperties in the audit logs for Azure Active Directory activities?**</span></span>

<span data-ttu-id="4e894-161">As TargetUpdatedProperties aparecem em ExtendedProperties.</span><span class="sxs-lookup"><span data-stu-id="4e894-161">TargetUpdatedProperties were appearing in ExtendedProperties.</span></span> <span data-ttu-id="4e894-162">No entanto, eles foram removidos das ExtendedProperties e aparecerão em ModifiedProperties.</span><span class="sxs-lookup"><span data-stu-id="4e894-162">However, they have been removed from ExtendedProperties and now appear in ModifiedProperties.</span></span>

## <a name="troubleshooting-the-office-365-management-activity-api"></a><span data-ttu-id="4e894-163">Solução de problemas da API da Atividade de Gestão do Office 365</span><span class="sxs-lookup"><span data-stu-id="4e894-163">Troubleshooting the Office 365 Management Activity API</span></span>

<span data-ttu-id="4e894-164">Qualquer pessoa que comece a usar a API da Atividade de Gestão do Office 365 deve entender que não há um conceito de consulta por informações específicas do evento, como a data em que ocorreu o evento, de qual coleção de sites um evento pode ter sido acionado ou o tipo de evento.</span><span class="sxs-lookup"><span data-stu-id="4e894-164">One thing that should be made clear for anyone who's getting started with the Office 365 Management Activity API is that there is no concept of querying by event specifics, such as date that the event occurred, which site collection an event might have been fired from, or the type of event.</span></span> <span data-ttu-id="4e894-165">Em vez disso, você cria assinaturas para cargas de trabalho específicas (por exemplo, Microsoft Office SharePoint Online ou Microsoft Azure Active Directory) e cada assinatura é por locatário.</span><span class="sxs-lookup"><span data-stu-id="4e894-165">Instead, you create subscriptions to specific workloads (for example, SharePoint or Azure AD) and each subscription is per tenant.</span></span>

<span data-ttu-id="4e894-166">As seções a seguir resumem as perguntas mais comuns que os clientes fazem ao usar a API da Atividade de Gestão do Office 365:</span><span class="sxs-lookup"><span data-stu-id="4e894-166">The following sections summarizes the most common questions that customers have in using the Office 365 Management Activity API:</span></span>

- [<span data-ttu-id="4e894-167">Perguntas sobre clientes e ferramentas de terceiros</span><span class="sxs-lookup"><span data-stu-id="4e894-167">Questions about third-party tools and clients</span></span>](#questions-about-third-party-tools-and-clients)

- [<span data-ttu-id="4e894-168">Habilitar o log de auditoria unificada no Office 365</span><span class="sxs-lookup"><span data-stu-id="4e894-168">Enabling unified audit logging in Office 365</span></span>](#enabling-unified-audit-logging-in-office-365)

- [<span data-ttu-id="4e894-169">Como conectar-se com a API</span><span class="sxs-lookup"><span data-stu-id="4e894-169">Connecting to the API</span></span>](#connecting-to-the-api)

- [<span data-ttu-id="4e894-170">Como verificar suas assinaturas</span><span class="sxs-lookup"><span data-stu-id="4e894-170">Checking your subscriptions</span></span>](#checking-your-subscriptions)

- [<span data-ttu-id="4e894-171">Como criar uma nova assinatura</span><span class="sxs-lookup"><span data-stu-id="4e894-171">Creating a new subscription</span></span>](#creating-a-new-subscription)

- [<span data-ttu-id="4e894-172">Como usar webhooks</span><span class="sxs-lookup"><span data-stu-id="4e894-172">Using webhooks</span></span>](#using-webhooks)

- [<span data-ttu-id="4e894-173">Como solicitar blobs de conteúdo e limitação</span><span class="sxs-lookup"><span data-stu-id="4e894-173">Requesting content blobs and throttling</span></span>](#requesting-content-blobs-and-throttling)

<span data-ttu-id="4e894-174">Mostraremos uma seleção de scripts simples do Windows PowerShell que podem ajudá-lo a responder às perguntas mais comuns feitas por clientes ou ajudar você a começar a implementar uma solução personalizada demonstrando as operações principais.</span><span class="sxs-lookup"><span data-stu-id="4e894-174">We'll show a selection of simple PowerShell scripts that can help you answer the most common questions asked by customers or get you started implementing a custom solution by demonstrating the main operations.</span></span> <span data-ttu-id="4e894-175">Nem todas as operações são explicadas neste artigo, mas estão listadas na referência da API da Atividade de Gestão do Office 365.</span><span class="sxs-lookup"><span data-stu-id="4e894-175">Not all the operations are explained in these sections, but they are all listed in Office 365 Management Activity API reference.</span></span>

### <a name="questions-about-third-party-tools-and-clients"></a><span data-ttu-id="4e894-176">Perguntas sobre clientes e ferramentas de terceiros</span><span class="sxs-lookup"><span data-stu-id="4e894-176">Questions about third-party tools and clients</span></span>

<span data-ttu-id="4e894-177">A categoria mais comum de perguntas que recebemos de clientes que usam produtos de terceiros para baixar e agregar dados de auditoria.</span><span class="sxs-lookup"><span data-stu-id="4e894-177">The most common category of questions come from customers using third-party products to download and aggregate auditing data.</span></span> <span data-ttu-id="4e894-178">Dependendo do produto de terceiros, os clientes podem encontrar dificuldades com a configuração ou observar uma interrupção ou inconsistência nos dados expostos nesses produtos.</span><span class="sxs-lookup"><span data-stu-id="4e894-178">Depending on the third-party product, customers may encounter difficulty with the setup or experience an interruption or an inconsistency in the data exposed in those products.</span></span> <span data-ttu-id="4e894-179">Devemos mencionar que a primeira ação que esses clientes devem realizar é entrar em contato com o departamento de suporte do fornecedor.</span><span class="sxs-lookup"><span data-stu-id="4e894-179">Here it should be stated that the first action such customers should take is to contact their vendor's support organization.</span></span> <span data-ttu-id="4e894-180">Geralmente, uma configuração de fornecedor específica do locatário ou um problema de serviço é a causa das queixas do cliente.</span><span class="sxs-lookup"><span data-stu-id="4e894-180">Typically, a tenant-specific vendor configuration or service problem is the cause of customer complaints.</span></span>

### <a name="enabling-unified-audit-logging-in-office-365"></a><span data-ttu-id="4e894-181">Habilitar o log de auditoria unificada no Office 365</span><span class="sxs-lookup"><span data-stu-id="4e894-181">Enabling unified audit logging in Office 365</span></span>

<span data-ttu-id="4e894-182">Se você acabou de configurar um aplicativo que está tentando usar a API de Atividade de Gerenciamento e não estiver funcionando, certifique-se de que ativou o registro em log de auditoria unificada para a sua organização do Office 365.</span><span class="sxs-lookup"><span data-stu-id="4e894-182">If you've just set up an app that's trying to use the Management Activity API and it's not working, be sure that you've enabled unified audit logging for your Office 365 organization.</span></span> <span data-ttu-id="4e894-183">Para fazer isso, ative o log de auditoria do Office 365.</span><span class="sxs-lookup"><span data-stu-id="4e894-183">You do this by turning on the Office 365 audit log.</span></span> <span data-ttu-id="4e894-184">Para obter instruções, confira [Ativar ou desativar a pesquisa de log de auditoria do Office 365](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).</span><span class="sxs-lookup"><span data-stu-id="4e894-184">For instructions, see [Turn Office 365 audit log search on or off](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).</span></span>

<span data-ttu-id="4e894-185">Se a auditoria unificada não estiver habilitada, uma mensagem de erro aparecerá contendo a cadeia de caracteres a seguir: `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`</span><span class="sxs-lookup"><span data-stu-id="4e894-185">If unified auditing isn't enabled, you will typically receive an error that contains the following string: `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`</span></span>

### <a name="connecting-to-the-api"></a><span data-ttu-id="4e894-186">Como conectar-se com a API</span><span class="sxs-lookup"><span data-stu-id="4e894-186">Connecting to the API</span></span>

<span data-ttu-id="4e894-187">A maioria dos aplicativos conecta-se à API usando um fluxo OAuth2 simples de Credenciais de Cliente.</span><span class="sxs-lookup"><span data-stu-id="4e894-187">Most applications connect to the API using a straightforward Client Credentials OAuth2 flow.</span></span> <span data-ttu-id="4e894-188">Portanto, a primeira etapa é criar um aplicativo do Azure AD que tenha as permissões necessárias para acessar os dados da API da Atividade de Gerenciamento.</span><span class="sxs-lookup"><span data-stu-id="4e894-188">Therefore, the first step is to create an Azure AD application that has the permissions needed to access the Management Activity API data.</span></span> <span data-ttu-id="4e894-189">Está fora do escopo deste artigo explicar as etapas para criar um registro de aplicativo do Microsoft Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="4e894-189">It's outside the scope of this article to explain the steps to create an Azure AD App registration.</span></span> <span data-ttu-id="4e894-190">Para saber mais, confira [Registrar seu aplicativo com o locatário do Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).</span><span class="sxs-lookup"><span data-stu-id="4e894-190">For more information, see [Register your application with your Azure Active Directory tenant](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).</span></span>

#### <a name="azure-application-permissions"></a><span data-ttu-id="4e894-191">Permissões de aplicativo do Azure</span><span class="sxs-lookup"><span data-stu-id="4e894-191">Azure application permissions</span></span>

<span data-ttu-id="4e894-192">As três permissões usadas no momento para a API da Atividade de Gerenciamento do Office 365 são:</span><span class="sxs-lookup"><span data-stu-id="4e894-192">The three permissions currently used for the Office 365 Management Activity API are:</span></span>

1. <span data-ttu-id="4e894-193">Ler dados de atividade para sua organização</span><span class="sxs-lookup"><span data-stu-id="4e894-193">Read activity data for your organization</span></span>

2. <span data-ttu-id="4e894-194">Ler as informações de integridade do serviço para sua organização</span><span class="sxs-lookup"><span data-stu-id="4e894-194">Read service health information for your organization</span></span>

3. <span data-ttu-id="4e894-195">Ler os eventos de política de Prevenção de Perda de Dados (DLP), incluindo informações confidenciais detectadas</span><span class="sxs-lookup"><span data-stu-id="4e894-195">Read Data Loss Prevention (DLP) policy events, including detected sensitive information</span></span>

> [!NOTE]
> <span data-ttu-id="4e894-196">Você deve habilitar as permissões de aplicativo e as permissões delegadas pelo menos para os primeiros dois dos conjuntos de permissões acima.</span><span class="sxs-lookup"><span data-stu-id="4e894-196">You should enable both the Application Permissions and the Delegated Permissions for at least the first two of the above permission sets.</span></span> <span data-ttu-id="4e894-197">Ler eventos de política DLP só será necessário se você estiver interessado nas cargas de trabalho DLP.</span><span class="sxs-lookup"><span data-stu-id="4e894-197">Read DLP policy events will only be necessary if you are interested in the DLP workloads.</span></span>

#### <a name="getting-an-access-token"></a><span data-ttu-id="4e894-198">Como obter um token de acesso</span><span class="sxs-lookup"><span data-stu-id="4e894-198">Getting an access token</span></span>

<span data-ttu-id="4e894-199">O seguinte script do PowerShell usa a ID do aplicativo e o segredo do cliente para obter o token do OAuth2 do ponto de extremidade de autenticação da API da Atividade de Gerenciamento.</span><span class="sxs-lookup"><span data-stu-id="4e894-199">The following PowerShell script uses the App ID and a Client Secret to obtain the OAuth2 token from the Management Activity API authentication endpoint.</span></span> <span data-ttu-id="4e894-200">Ele, em seguida, coloca o token de acesso na variável de matriz do `$headerParams`, que você anexará à sua solicitação HTTP.</span><span class="sxs-lookup"><span data-stu-id="4e894-200">It then places the access token into the `$headerParams` array variable, which you'll attach to your HTTP request.</span></span> <span data-ttu-id="4e894-201">Para o valor do ponto de extremidade da API (na variável $resource), use um dos seguintes valores com base no plano de assinatura do Microsoft 365 ou do Office 365 da sua organização:</span><span class="sxs-lookup"><span data-stu-id="4e894-201">For the value for the API endpoint (in the $resource variable) use one of the following values based on your organization's Microsoft 365 or Office 365 subscription plan:</span></span>

- <span data-ttu-id="4e894-202">Plano empresarial: `manage.office.com`</span><span class="sxs-lookup"><span data-stu-id="4e894-202">Enterprise plan: `manage.office.com`</span></span>

- <span data-ttu-id="4e894-203">Plano governamental do GCC: `manage-gcc.office.com`</span><span class="sxs-lookup"><span data-stu-id="4e894-203">GCC government plan: `manage-gcc.office.com`</span></span>

- <span data-ttu-id="4e894-204">Plano de alto governo GCC: `manage.office365.us`</span><span class="sxs-lookup"><span data-stu-id="4e894-204">GCC High government plan: `manage.office365.us`</span></span>

- <span data-ttu-id="4e894-205">Plano governamental DoD: `manage.protection.apps.mil`</span><span class="sxs-lookup"><span data-stu-id="4e894-205">DoD government plan: `manage.protection.apps.mil`</span></span>

```powershell
# Create app of type Web app / API in Azure AD, generate a Client Secret, and update the client id and client secret here
$ClientID = "<YOUR_APPLICATION_ID"
$ClientSecret = "<YOUR_CLIENT_SECRET>"
$loginURL = "https://login.microsoftonline.com/"
$tenantdomain = "<YOUR_DOMAIN>.onmicrosoft.com"
# Get the tenant GUID from Properties | Directory ID under the Azure Active Directory section. For $resource, use one of these endpoint values based on your subscription plan: Enterprise - manage.office.com; GCC - manage-gcc.office.com; GCC High: manage.office365.us; DoD: manage.protection.apps.mil
$TenantGUID = "<YOUR_TENANT_GUID>"
$resource = "https://<YOUR_API_ENDPOINT>"
# auth
$body = @{grant_type="client_credentials";resource=$resource;client_id=$ClientID;client_secret=$ClientSecret}
$oauth = Invoke-RestMethod -Method Post -Uri $loginURL/$tenantdomain/oauth2/token?api-version=1.0 -Body $body
$headerParams = @{'Authorization'="$($oauth.token_type) $($oauth.access_token)"} 
```

<span data-ttu-id="4e894-206">A variável `$oauth` conterá o objeto de resposta que tem várias propriedades, incluindo o token de acesso.</span><span class="sxs-lookup"><span data-stu-id="4e894-206">The `$oauth` variable will contain the response object, which has several properties including the access token.</span></span> <span data-ttu-id="4e894-207">Um exemplo de resposta:</span><span class="sxs-lookup"><span data-stu-id="4e894-207">Here's an example of a response:</span></span>

```json
token_type     : Bearer
expires_in     : 3599
ext_expires_in : 0
expires_on     : 1508285860
not_before     : 1508281960
resource       : https://manage.office.com
access_token   : eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyIsImtpZCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyJ9.eyJhdWQiOiJodHRwczov…
```

### <a name="checking-your-subscriptions"></a><span data-ttu-id="4e894-208">Como verificar suas assinaturas</span><span class="sxs-lookup"><span data-stu-id="4e894-208">Checking your subscriptions</span></span>

<span data-ttu-id="4e894-209">Se você já passou por uma interrupção no fluxo de dados para uma solução ou cliente de API da Atividade de Gestão existente, pode estar se perguntando se algo aconteceu com a sua assinatura.</span><span class="sxs-lookup"><span data-stu-id="4e894-209">If you've experienced an interruption in data flowing to an existing Management Activity API client or solution, you might wonder if something happened to your subscription.</span></span> <span data-ttu-id="4e894-210">Para verificar suas assinaturas ativas, adicione o seguinte ao script anterior:</span><span class="sxs-lookup"><span data-stu-id="4e894-210">To check your active subscriptions, add the following to the previous script:</span></span>

```powershell
Invoke-WebRequest -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/list" 
```

#### <a name="sample-response"></a><span data-ttu-id="4e894-211">Resposta de amostra</span><span class="sxs-lookup"><span data-stu-id="4e894-211">Sample response</span></span>

```json
StatusCode        : 200
Status Description : OK
Content           : [{"contentType":"Audit.Exchange","status":"enabled","webhook":null},{"contentType":"Audit.SharePoint","status":"enabled","webhook":{"authId":"","address":"https://mvcwebapiwebhookreceiver.azurewebsite...
RawContent        : HTTP/1.1 200 OK
                    Pragma: no-cache
                    Content-Length: 266
                    Cache-Control: no-cache
                    Content-Type: application/json; charset=utf-8
                    Expires: -1
                    Server: Microsoft-IIS/8.5,Microsoft-IIS/8.5
                    X-AspNet-Versi...
Forms             : {}
Headers           : {[Pragma, no-cache], [Content-Length, 266], [Cache-Control, no-cache], [Content-Type, application/json; charset=utf-8]...}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 266
```

<span data-ttu-id="4e894-212">Isso informa que o locatário tem as assinaturas Audit.Exchange e Audit.SharePoint habilitadas.</span><span class="sxs-lookup"><span data-stu-id="4e894-212">This says that the tenant has both Audit.Exchange and Audit.SharePoint subscriptions enabled.</span></span> <span data-ttu-id="4e894-213">A assinatura do Exchange não tem webhook habilitado (nulo) e a assinatura do SharePoint tem um webhook habilitado com o endereço do ponto de extremidade registrado mostrado.</span><span class="sxs-lookup"><span data-stu-id="4e894-213">The Exchange subscription has no webhook enabled (null) and the SharePoint subscription has a webhook enabled with the address of the registered endpoint shown.</span></span>

### <a name="creating-a-new-subscription"></a><span data-ttu-id="4e894-214">Como criar uma nova assinatura</span><span class="sxs-lookup"><span data-stu-id="4e894-214">Creating a new subscription</span></span>

<span data-ttu-id="4e894-215">Para criar uma nova assinatura, use a operação /start.</span><span class="sxs-lookup"><span data-stu-id="4e894-215">To create a new subscription, you use the /start operation.</span></span> <span data-ttu-id="4e894-216">Para o ponto de extremidade da API, use um destes valores de base do seu plano de assinatura:</span><span class="sxs-lookup"><span data-stu-id="4e894-216">For the API endpoint, use one of these values base on your subscription plan:</span></span>

- <span data-ttu-id="4e894-217">Plano empresarial: `manage.office.com`</span><span class="sxs-lookup"><span data-stu-id="4e894-217">Enterprise plan: `manage.office.com`</span></span>

- <span data-ttu-id="4e894-218">Plano governamental do GCC: `manage-gcc.office.com`</span><span class="sxs-lookup"><span data-stu-id="4e894-218">GCC government plan: `manage-gcc.office.com`</span></span>

- <span data-ttu-id="4e894-219">Plano de alto governo GCC: `manage.office365.us`</span><span class="sxs-lookup"><span data-stu-id="4e894-219">GCC High government plan: `manage.office365.us`</span></span>

- <span data-ttu-id="4e894-220">Plano governamental DoD: `manage.protection.apps.mil`</span><span class="sxs-lookup"><span data-stu-id="4e894-220">DoD government plan: `manage.protection.apps.mil`</span></span>

```powershell
Invoke-WebRequest -Method Post -Headers $headerParams -Uri "https://<YOUR_API_ENDPOINT>/api/v1.0/$tenantGUID/activity/feed/subscriptions/start?contentType=Audit.AzureActiveDirectory"

> [!NOTE]
> Remember that `$headerParams` was populated in the first part of the script listed in the [Connecting to the API](#connecting-to-the-api) section in this article.

The previous code will create a new subscription to the Audit.AzureActiveDirectory content type, with a webhook that is null. You can then check your subscriptions using the code in the [Checking your subscriptions](#checking-your-subscriptions) section in this article.

## Checking content availability

To check what content blobs were created during a certain period, you can add the following line to the script in the “Connecting to the API” section.

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint"
```

<span data-ttu-id="4e894-221">O exemplo anterior receberá todas as notificações de conteúdo que foram disponibilizadas hoje, ou seja de 12:00 UTC até a hora atual.</span><span class="sxs-lookup"><span data-stu-id="4e894-221">The previous example will get all the content notifications that became available today, which means from 12:00 AM UTC to the current time.</span></span> <span data-ttu-id="4e894-222">Se você quiser especificar um período diferente (tendo em mente que o período máximo para o qual você pode consultar é 24 horas), adicione os parâmetros *starttime* e *endtime* ao URI; por exemplo:</span><span class="sxs-lookup"><span data-stu-id="4e894-222">If you want to specify a different time period (keeping in mind that the maximum period for which you can query is 24 hours), add the *starttime* and *endtime* parameters to the URI; for example:</span></span>

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint&startTime=2017-10-13T00:00&endTime=2017-10-13T11:59"
```

> [!NOTE]
> <span data-ttu-id="4e894-223">Você deve usar os parâmetros *starttime* e *endtime* ou nenhum.</span><span class="sxs-lookup"><span data-stu-id="4e894-223">You must use either both *starttime* and *endtime* parameters or neither.</span></span>

```json
[{      "contentUri" : "https://<your_API_endpoint>/api/v1.0/<your_tenant_guid>/activity/feed/audit/20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentId" : "20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentType" : "Audit.SharePoint",
        "contentCreated" : "2017-10-13T18:00:51.748Z",
        "contentExpiration" : "2017-10-20T18:00:51.748Z",
}]
```

> [!IMPORTANT]
>
> - <span data-ttu-id="4e894-224">A propriedade *contentUri* é o URI onde você pode recuperar blobs de conteúdo.</span><span class="sxs-lookup"><span data-stu-id="4e894-224">The *contentUri* property is the URI from which you can retrieve the content blob.</span></span> <span data-ttu-id="4e894-225">O blob em si é o que contém os detalhes do evento; ele inclui detalhes sobre eventos 1 – N.</span><span class="sxs-lookup"><span data-stu-id="4e894-225">The blob itself is what contains the event details; it will contain details about 1 – N events.</span></span> <span data-ttu-id="4e894-226">Embora possa haver 30 objetos JSON na coleção, pode haver vários eventos mais detalhados nesses 30 URIs de conteúdo.</span><span class="sxs-lookup"><span data-stu-id="4e894-226">While there may be 30 JSON objects in the collection, there may be many more events detailed in those 30 content URIs.</span></span>
>
> - <span data-ttu-id="4e894-227">A propriedade *contentCreated* não é a data de criação do evento que está sendo notificado.</span><span class="sxs-lookup"><span data-stu-id="4e894-227">The *contentCreated* property is not the date that the event being notified was created.</span></span> <span data-ttu-id="4e894-228">Esta é a data de criação da notificação.</span><span class="sxs-lookup"><span data-stu-id="4e894-228">This is the date the notification was created.</span></span> <span data-ttu-id="4e894-229">Os eventos detalhados nesse blob podem ter sido criados bem antes de o blob de conteúdo ter sido criado.</span><span class="sxs-lookup"><span data-stu-id="4e894-229">The events detailed in that blob may have been created well before the content blob was created.</span></span> <span data-ttu-id="4e894-230">Portanto, você nunca pode consultar a API diretamente para os eventos ocorridos durante um período determinado.</span><span class="sxs-lookup"><span data-stu-id="4e894-230">Therefore, you can never query the API directly for events that occurred within any given period.</span></span>

#### <a name="paging-contents-for-busy-tenants"></a><span data-ttu-id="4e894-231">Como paginar conteúdo para locatários ocupados</span><span class="sxs-lookup"><span data-stu-id="4e894-231">Paging contents for busy tenants</span></span>

<span data-ttu-id="4e894-232">Vários locatários maiores do Office 365 têm milhares de eventos que estão sendo gerados a cada hora.</span><span class="sxs-lookup"><span data-stu-id="4e894-232">Many larger Office 365 tenants have thousands of events being generated every hour.</span></span> <span data-ttu-id="4e894-233">Se esse for o caso da sua organização e você tentar executar uma consulta por um período de 24 horas, como no exemplo acima, talvez seja necessário recuperar mais notificações que podem ser retornadas em uma resposta.</span><span class="sxs-lookup"><span data-stu-id="4e894-233">If this is the case with your organization, and you try to execute a query for a 24-hour period like in the example above, you may need to retrieve more notifications than can be returned in one response.</span></span> <span data-ttu-id="4e894-234">Nesse caso, você precisará implementar um loop lógico de algum tipo sempre verificando os cabeçalhos de resposta para o valor do cabeçalho **NextPageUrl:**.</span><span class="sxs-lookup"><span data-stu-id="4e894-234">In this case, you'll need to implement a logical loop of some kind, each time checking the response headers for the **NextPageUrl:** header value.</span></span> <span data-ttu-id="4e894-235">Confira a seção Paginação na referência da API da Atividade de Gestão do Office 365 para obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="4e894-235">See the Pagination section in the Office 365 Management Activity API reference for more details.</span></span>

```powershell
IF the NextPageUrl header is present in the response... 

THEN issue a new request substituting the Uri parameter in the above Invoke-WebRequest example for the value of the NextPageUrl header...
 
ELSE exit the loop
```

<span data-ttu-id="4e894-236">É difícil testar isso código de loop a menos que você tenha um locatário muito ativo.</span><span class="sxs-lookup"><span data-stu-id="4e894-236">It will be difficult to test this looping code unless you have a very active tenant.</span></span> <span data-ttu-id="4e894-237">No nosso teste, tentamos executar milhares de operações de atualização em um script e não foi possível gerar um número grande o suficiente de notificações para exigir que o cabeçalho **NextPageUrl** fosse enviado.</span><span class="sxs-lookup"><span data-stu-id="4e894-237">In our testing, we tried to execute several thousand update operations in a script and was unable to generate a large enough number of notifications to require the **NextPageUrl** header to be sent.</span></span>

### <a name="using-webhooks"></a><span data-ttu-id="4e894-238">Como usar webhooks</span><span class="sxs-lookup"><span data-stu-id="4e894-238">Using webhooks</span></span>

<span data-ttu-id="4e894-239">Há duas maneiras de obter uma notificação informando que os blobs de conteúdo foram criados.</span><span class="sxs-lookup"><span data-stu-id="4e894-239">There two ways to get a notification that content blobs have been created.</span></span> <span data-ttu-id="4e894-240">A abordagem *push* é implementada com um ponto de extremidade de webhook, que é um aplicativo Web que você cria e hospeda por conta própria ou em uma plataforma de nuvem.</span><span class="sxs-lookup"><span data-stu-id="4e894-240">The *push* approach is implemented with a webhook endpoint, which is a web application that you create and host yourself or on a cloud platform.</span></span> <span data-ttu-id="4e894-241">Registre o webhook sempre que criar uma assinatura para um tipo de conteúdo auditado.</span><span class="sxs-lookup"><span data-stu-id="4e894-241">You register the webhook at the time you create a subscription to an audited content type.</span></span> <span data-ttu-id="4e894-242">Você também pode adicionar um registro de webhook a uma assinatura existente usando a abordagem mostrada abaixo.</span><span class="sxs-lookup"><span data-stu-id="4e894-242">You may also add a webhook registration to an existing subscription using the approach shown below.</span></span> <span data-ttu-id="4e894-243">A abordagem *pull* exige que você consulte um determinado período de tempo (não mais de 24 horas) usando a operação /content.</span><span class="sxs-lookup"><span data-stu-id="4e894-243">The *pull* approach requires you to query for a particular timespan (no more than 24 hours) using the /content operation.</span></span> <span data-ttu-id="4e894-244">A resposta indicará quais blobs de conteúdo foram criados durante o período especificado.</span><span class="sxs-lookup"><span data-stu-id="4e894-244">The response will tell you which content blobs were created during the period specified.</span></span>

<span data-ttu-id="4e894-245">Antes de adicionar um webhook, esteja ciente dos dois problemas a seguir:</span><span class="sxs-lookup"><span data-stu-id="4e894-245">Before you add a webhook, be aware of the following two issues:</span></span>

1. <span data-ttu-id="4e894-246">Os webhooks estão perdendo a ênfase da Microsoft devido à dificuldade de depurar e solucionar problemas.</span><span class="sxs-lookup"><span data-stu-id="4e894-246">Webhooks are being de-emphasized by Microsoft because of the difficulty in debugging and troubleshooting.</span></span> <span data-ttu-id="4e894-247">Normalmente, você hospedaria um ponto de extremidade de WebApi que respondesse a solicitações de entrada.</span><span class="sxs-lookup"><span data-stu-id="4e894-247">Typically, you would host a WebApi endpoint that responds to incoming requests.</span></span> <span data-ttu-id="4e894-248">Muitos clientes usam ambientes de hospedagem (sob os quais não têm controle total) ou em ambientes locais (que têm dificuldades para permitir solicitações HTTP de entrada).</span><span class="sxs-lookup"><span data-stu-id="4e894-248">Many customers either use hosting environments (which they don't have full control over) or on-premises environments (that have difficulty allowing incoming HTTP requests).</span></span> <span data-ttu-id="4e894-249">O suporte observou muitos problemas em que as solicitações de entrada do pipeline de auditoria do Office 365 foram bloqueadas por um firewall ou roteador.</span><span class="sxs-lookup"><span data-stu-id="4e894-249">Support has seen many problems where the incoming requests from the Office 365 auditing pipeline have been blocked by a firewall or router.</span></span> <span data-ttu-id="4e894-250">Nesse caso, a API implementará um algoritmo de retirada, que pode ser confuso e resultar na desabilitação do webhook na assinatura.</span><span class="sxs-lookup"><span data-stu-id="4e894-250">In this case, the API will implement a back-off algorithm, which can be confusing and may result in disabling the webhook in the subscription.</span></span>

2. <span data-ttu-id="4e894-251">O webhook deverá estar pronto para responder imediatamente a uma solicitação de validação depois que a operação de início for executada.</span><span class="sxs-lookup"><span data-stu-id="4e894-251">The webhook must be ready to immediately respond to a validation request after the start operation is executed.</span></span> <span data-ttu-id="4e894-252">Se houver um bug no aplicativo de webhook, a validação falhará e o webhook não será habilitado.</span><span class="sxs-lookup"><span data-stu-id="4e894-252">If there is a bug in the webhook application, the validation will fail, and the webhook will not be enabled.</span></span> <span data-ttu-id="4e894-253">Para saber mais sobre o esquema de solicitação de validação, confira a seção Validação de webhook na referência da API da Atividade de Gestão do Office 365.</span><span class="sxs-lookup"><span data-stu-id="4e894-253">For information about the validation request schema, see the Webhook validation section in the Office 365 Management Activity API reference.</span></span> <span data-ttu-id="4e894-254">Você deve levar em consideração os desafios na produção de um webhook pronto para produção para responder a notificações da API da Atividade de Gerenciamento.</span><span class="sxs-lookup"><span data-stu-id="4e894-254">You should seriously consider the challenges in producing a production-ready webhook to respond to Management Activity API notifications.</span></span>

<span data-ttu-id="4e894-255">Se você decidir implementar um webhook, ele deverá ser testado para verificar se o ponto de extremidade está preparado para responder com uma resposta HTTP 200 à solicitação de validação e às solicitações de notificação normal antes de qualquer operação /start que especifica que um ponto de extremidade de webhook ser chamada pela primeira vez.</span><span class="sxs-lookup"><span data-stu-id="4e894-255">If you decide to implement a webhook, it should be tested to verify that the endpoint is prepared to respond with an HTTP 200 response to both the validation request and the normal notification requests before any /start operation that specifies a webhook endpoint is called for the first time.</span></span> <span data-ttu-id="4e894-256">Normalmente, você usaria uma solicitação fictícia da API para testar essa preparação.</span><span class="sxs-lookup"><span data-stu-id="4e894-256">Typically, you would use a mocked request from the API to test this readiness.</span></span> <span data-ttu-id="4e894-257">Leia com atenção e observe as seções Validação de webhook e Recuperando conteúdo na referência da API da Atividade de Gerenciamento do Office 365 para entender o esquema desses dois tipos de solicitações.</span><span class="sxs-lookup"><span data-stu-id="4e894-257">Carefully read and observe both the Webhook validation and Retrieving content sections in the Office 365 Management Activity API reference to understand the schema of these two types of requests.</span></span>

<span data-ttu-id="4e894-258">Para adicionar uma assinatura com um ponto de extremidade de webhook, adicione um parâmetro de corpo ao POST para o ponto de extremidade /start; por exemplo:</span><span class="sxs-lookup"><span data-stu-id="4e894-258">To add a subscription with a webhook endpoint, add a body parameter to the POST to the /start endpoint; for example:</span></span>

```json
$body = '{
    "webhook" : {
        "address": "https://webhook.myapp.com/o365/",
        "authId": "o365activityapinotification",
        "expiration": ""
    }}'
$uri = "https://manage.office.com/api/v1.0/$tenantGUID/activity/feed//subscriptions/start?contentType=Audit.SharePoint"
Invoke-RestMethod -Method Post -uri $uri -Headers $headerParams -Body $body
```

<span data-ttu-id="4e894-259">Imediatamente após essa chamada, uma solicitação de validação será enviada para o `https://webhook.myapp.com/o365/ …` e deve haver um ouvinte preparado para responder, de acordo com a descrição na seção Validação de webhook na referência da API da Atividade de Gerenciamento do Office 365.</span><span class="sxs-lookup"><span data-stu-id="4e894-259">Immediately following this call, a validation request will be sent out to `https://webhook.myapp.com/o365/ …` and there should be a listener ready to respond, as per the description in the Webhook validation section in the Office 365 Management Activity API reference.</span></span> <span data-ttu-id="4e894-260">Seu ouvinte deve responder com HTTP 200.</span><span class="sxs-lookup"><span data-stu-id="4e894-260">Your listener must respond with HTTP 200.</span></span> <span data-ttu-id="4e894-261">Se você executar a operação /list imediatamente nesse ponto, não verá o webhook mostrado como algo diferente de nulo até que a validação seja retornada.</span><span class="sxs-lookup"><span data-stu-id="4e894-261">If you immediately run the /list operation at this point, you will not see the webhook shown as other than null until the validation has returned successfully.</span></span>

#### <a name="checking-notifications-to-webhooks"></a><span data-ttu-id="4e894-262">Como verificar notificações para webhooks</span><span class="sxs-lookup"><span data-stu-id="4e894-262">Checking notifications to webhooks</span></span>

<span data-ttu-id="4e894-263">É importante distinguir entre a operação /notifications e a operação /content.</span><span class="sxs-lookup"><span data-stu-id="4e894-263">It's important to distinguish between the /notifications operation and the /content operation.</span></span> <span data-ttu-id="4e894-264">Verificar as notificações só será relevante se você tiver assinado um ponto de extremidade de webhook.</span><span class="sxs-lookup"><span data-stu-id="4e894-264">Checking notifications is only relevant if you have subscribed with a webhook endpoint.</span></span> <span data-ttu-id="4e894-265">Esta operação informará se as tentativas de enviar notificações para seu webhook tiveram êxito ou não.</span><span class="sxs-lookup"><span data-stu-id="4e894-265">This operation will let you know if attempts to send notifications to your webhook have been successful or not.</span></span> <span data-ttu-id="4e894-266">Essa operação não deve ser usada para listar o conteúdo disponível.</span><span class="sxs-lookup"><span data-stu-id="4e894-266">This operation should not be used to list available content.</span></span> <span data-ttu-id="4e894-267">Para verificar a disponibilidade de conteúdo em relação ao que você pode já ter recebeu no seu webhook, use a operação /content.</span><span class="sxs-lookup"><span data-stu-id="4e894-267">To cross-check the availability of content against what you may have already received in your webhook, you would use the /content operation.</span></span> <span data-ttu-id="4e894-268">Mas primeiro verifique se há notificações de falhas usando a operação /notifications.</span><span class="sxs-lookup"><span data-stu-id="4e894-268">But be sure to first check for failed notifications using the /notifications operation.</span></span>

### <a name="requesting-content-blobs-and-throttling"></a><span data-ttu-id="4e894-269">Como solicitar blobs de conteúdo e limitação</span><span class="sxs-lookup"><span data-stu-id="4e894-269">Requesting content blobs and throttling</span></span>

<span data-ttu-id="4e894-270">Depois que você tiver obtido uma lista de URIs de conteúdo, será necessário solicitar os blobs especificados pelas URIs.</span><span class="sxs-lookup"><span data-stu-id="4e894-270">After you've obtained a list of content URIs, you must request the blobs specified by the URIs.</span></span> <span data-ttu-id="4e894-271">A seguir está um exemplo de solicitação de um blob de conteúdo (utilizando o terminal da API em manage.office.com para organizações empresariais) utilizando o Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="4e894-271">The following is an example of requesting a content blob (using the manage.office.com API endpoint for Enterprise organizations) using PowerShell.</span></span> <span data-ttu-id="4e894-272">Esse exemplo supõe que você já usou o exemplo anterior na seção [Obtendo um token de acesso](#getting-an-access-token) deste artigo para obter um token de acesso e preencheu a variável `$headerParams` corretamente.</span><span class="sxs-lookup"><span data-stu-id="4e894-272">This example assumes you have already used the previous example in the [Getting an access token](#getting-an-access-token) section in this article to get an access token and have populated the `$headerParams` variable appropriately.</span></span>

```powershell
# Get a content blob
$uri = 'https://manage.office.com/api/v1.0/<<your-tenant-guid>>/activity/feed/audit/<<ContentID>$audit_sharepoint$Audit_SharePoint'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

<span data-ttu-id="4e894-273">Observe o seguinte sobre a variável *$uri* no exemplo anterior:</span><span class="sxs-lookup"><span data-stu-id="4e894-273">Note the following things about the *$uri* variable in the previous example:</span></span>

- <span data-ttu-id="4e894-274">Usamos aspas simples para que os símbolos *$* não sejam interpretados como variáveis no Windows PowerShell</span><span class="sxs-lookup"><span data-stu-id="4e894-274">We used single quotes so that the *$* symbols aren't interpreted as variables in PowerShell</span></span>

- <span data-ttu-id="4e894-275">O URI inteiro será retornado na propriedade *contentUri* da resposta à sua chamada anterior para o ponto de extremidade /content.</span><span class="sxs-lookup"><span data-stu-id="4e894-275">The entire URI will be returned in the *contentUri* property of the response to your previous call to the /content endpoint.</span></span> <span data-ttu-id="4e894-276">Os tokens de espaço reservado mostrados são apenas para ilustração.</span><span class="sxs-lookup"><span data-stu-id="4e894-276">The placeholder tokens shown are just for illustration.</span></span>

<span data-ttu-id="4e894-277">Ao tentar recuperar os blobs de conteúdo disponíveis, muitos clientes (principalmente os que trabalham com locatários ocupados) observaram erros parecidos com isso:</span><span class="sxs-lookup"><span data-stu-id="4e894-277">When attempting to retrieve the available content blobs, many customers (mostly working with busy tenants) have experienced errors that look like this:</span></span>

```json
Response Code 403: {'error':{'code':'AF429','message':'Too many requests. Method=GetBlob, PublisherId=00000000-0000-0000-0000-000000000000'}}
```

<span data-ttu-id="4e894-278">Isso provavelmente é devido à limitação.</span><span class="sxs-lookup"><span data-stu-id="4e894-278">This is likely due to throttling.</span></span> <span data-ttu-id="4e894-279">Observe que o valor do parâmetro PublisherId provavelmente indica que o cliente não especificou o *PublisherIdentifier* na solicitação.</span><span class="sxs-lookup"><span data-stu-id="4e894-279">Note that the value of the PublisherId parameter likely indicates that the client didn't specify the *PublisherIdentifier* in the request.</span></span> <span data-ttu-id="4e894-280">Além disso, tenha em mente que o nome do parâmetro correto é *PublisherIdentifier* mesmo que você veja *PublisherId* listado nas respostas de erro 403.</span><span class="sxs-lookup"><span data-stu-id="4e894-280">Also, keep in mind that the correct parameter name is *PublisherIdentifier* even though you see *PublisherId* listed in the 403 error responses.</span></span>

> [!NOTE]
> <span data-ttu-id="4e894-281">Na referência de API, o parâmetro *PublisherIdentifier* está listado em cada operação da API, mas ele também deverá será incluído na solicitação GET para a URL contentUri ao recuperar blobs de conteúdo.</span><span class="sxs-lookup"><span data-stu-id="4e894-281">In the API reference, the *PublisherIdentifier* parameter is listed in every operation of the API, but it should also be included in the GET request to the contentUri URL when retrieving the content blob.</span></span>

<span data-ttu-id="4e894-282">Se você estiver fazendo chamadas simples de API para solucionar problemas (por exemplo, verificando se uma determinado assinatura está ativa), você pode omitir com segurança o parâmetro *PublisherIdentifier*, mas qualquer código que seja importante para uso de produção deverá incluir o parâmetro *PublisherIdentifier* em todas as chamadas.</span><span class="sxs-lookup"><span data-stu-id="4e894-282">If you're doing simple API calls to troubleshoot problems (for example, checking if a given subscription is active) you can safely omit the *PublisherIdentifier* parameter, but absolutely any code that is eventually meant for production use should include the *PublisherIdentifier* parameter on every call.</span></span>

<span data-ttu-id="4e894-283">Se você estiver implementando um cliente para o locatário da sua empresa, o *PublisherIdentifier* será o GUID de locatário.</span><span class="sxs-lookup"><span data-stu-id="4e894-283">If you're implementing a client for your company's tenant, the *PublisherIdentifier* is the Tenant GUID.</span></span> <span data-ttu-id="4e894-284">Se você estiver criando um aplicativo de ISV ou suplemento para vários clientes, o *PublisherIdentifier* será a GUID de locatário do ISV e não a GUID de locatário da empresa do usuário final.</span><span class="sxs-lookup"><span data-stu-id="4e894-284">If you are creating an ISV application or add-in for multiple customers, the *PublisherIdentifier* should be the ISV's Tenant GUID, and not the tenant GUID of end user's company.</span></span>

<span data-ttu-id="4e894-285">Se você incluir o *PublisherIdentifier* válido, estará em um pool alocado com 60 mil solicitações por minuto por locatário.</span><span class="sxs-lookup"><span data-stu-id="4e894-285">If you include the valid *PublisherIdentifier*, then you will be in a pool that is allotted 60K requests per minute per tenant.</span></span> <span data-ttu-id="4e894-286">Este é um número de solicitações excepcionalmente grande.</span><span class="sxs-lookup"><span data-stu-id="4e894-286">This is an exceptionally large number of requests.</span></span> <span data-ttu-id="4e894-287">No entanto, se você não incluir o parâmetro *PublisherIdentifier*, você estará no pool geral alocado com 60 mil solicitações por minuto para todos os locatários.</span><span class="sxs-lookup"><span data-stu-id="4e894-287">However, if you don't include the *PublisherIdentifier* parameter, you will be in the general pool allotted 60K requests per minute for all tenants.</span></span> <span data-ttu-id="4e894-288">Nesse caso, você provavelmente achará que suas chamadas estão ficando limitadas.</span><span class="sxs-lookup"><span data-stu-id="4e894-288">In this case, you will more than likely find that your calls are getting throttled.</span></span> <span data-ttu-id="4e894-289">Para evitar isso, veja aqui como é possível solicitar um blob de conteúdo usando o *PublisherIdentifier*:</span><span class="sxs-lookup"><span data-stu-id="4e894-289">To prevent this, here's how you would request a content blob using the *PublisherIdentifier*:</span></span>

```json
$contentUri = ($response.Content | ConvertFrom-Json).contentUri[0]
$uri = $contentUri + '?PublisherIdentifier=82b24b6d-0591-4604-827b-705d55d0992f'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

<span data-ttu-id="4e894-290">O exemplo anterior pressupõe que a variável *$response* foi preenchida com a resposta a uma solicitação para o ponto de extremidade /content e que a variável *$headerParams* inclui um token de acesso válido.</span><span class="sxs-lookup"><span data-stu-id="4e894-290">The previous example assumes that the *$response* variable was populated with the response to a request to the /content endpoint and that the *$headerParams* variable includes a valid access token.</span></span> <span data-ttu-id="4e894-291">O script utiliza o primeiro item na matriz de URIs de conteúdo da resposta e invoca GET para fazer o download desse blog e colocá-lo na variável *$contents*.</span><span class="sxs-lookup"><span data-stu-id="4e894-291">The script grabs the first item in the array of content URIs from the response and then invokes the GET to download that blob and put it in the *$contents* variable.</span></span> <span data-ttu-id="4e894-292">O código provavelmente percorrerá a coleção contentUri emitindo o GET para cada *contentUri*.</span><span class="sxs-lookup"><span data-stu-id="4e894-292">Your code will likely loop through the contentUri collection, issuing the GET for each *contentUri*.</span></span>
